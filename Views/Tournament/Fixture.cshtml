@model List<RoboticsFixture.Models.Match>

@{
    ViewData["Title"] = "Fixture";
    var category = ViewBag.Category;
    var maxRound = ViewBag.MaxRound;
    var showPodium = ViewBag.ShowPodium;
    var rounds = Model.GroupBy(m => m.Round).OrderBy(g => g.Key).ToList();
}

<div class="mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <h1>
            <i class="fas fa-sitemap me-2"></i> Fixture - @category
        </h1>
        <a asp-action="Index" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Volver
        </a>
    </div>
</div>

@if (!Model.Any())
{
    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        No se ha generado el fixture para esta categoría.
        <a asp-action="Index" class="alert-link">Volver para generar</a>
    </div>
}
else
{
    @if (showPodium)
    {
        <div class="alert alert-info mb-4">
            <i class="fas fa-trophy me-2"></i>
            ¡El torneo ha finalizado!
            <a asp-action="Podium" asp-route-category="@category" class="alert-link fw-bold">Ver Podio de Ganadores</a>
        </div>
    }

    <div class="fixture-container">
        <div class="rounds-wrapper">
            @for (int r = 1; r <= maxRound; r++)
            {
                var roundMatches = rounds.FirstOrDefault(g => g.Key == r)?.ToList() ?? new List<Match>();
                var roundName = r == maxRound && roundMatches.Count == 1 ? "FINAL" :
                r == maxRound - 1 && roundMatches.Count == 2 ? "SEMIFINAL" :
                r == maxRound - 2 && roundMatches.Count == 4 ? "CUARTOS" :
                $"RONDA {r}";

                <div class="round-column">
                    <div class="round-header">
                        <i class="fas fa-layer-group me-2"></i>@roundName
                    </div>

                    @foreach (var match in roundMatches)
                    {
                        <div class="match-card @(match.IsCompleted ? "completed" : "") @(match.IsBye ? "bye" : "")">
                            @if (match.IsCompleted && !match.IsBye)
                            {
                                <div class="winner-badge">
                                    <i class="fas fa-trophy"></i>
                                </div>
                            }

                            @if (match.IsBye)
                            {
                                <div class="text-center">
                                    <div class="competitor-slot winner">
                                        <div class="competitor-info">
                                            <i class="fas fa-robot competitor-icon"></i>
                                            <div class="competitor-details">
                                                <h6>@match.Competitor1?.Name</h6>
                                                <small>@match.Competitor1?.Team</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="bye-badge mt-3">
                                        <i class="fas fa-fast-forward me-2"></i>PASE DIRECTO
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="competitor-slot @(match.WinnerId == match.Competitor1Id ? "winner" : "")">
                                    <div class="competitor-info">
                                        <i class="fas fa-robot competitor-icon"></i>
                                        <div class="competitor-details">
                                            <h6>@(match.Competitor1?.Name ?? "TBD")</h6>
                                            <small>@match.Competitor1?.Team</small>
                                        </div>
                                    </div>
                                    @if (!match.IsCompleted && match.Competitor1 != null && match.Competitor2 != null)
                                    {
                                        <form asp-action="SetWinner" method="post" style="display:inline;">
                                            <input type="hidden" name="matchId" value="@match.Id" />
                                            <input type="hidden" name="winnerId" value="@match.Competitor1Id" />
                                            <button type="submit" class="btn btn-sm btn-success">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        </form>
                                    }
                                </div>

                                <div class="match-vs">
                                    <i class="fas fa-bolt"></i> VS <i class="fas fa-bolt"></i>
                                </div>

                                <div class="competitor-slot @(match.WinnerId == match.Competitor2Id ? "winner" : "")">
                                    <div class="competitor-info">
                                        <i class="fas fa-robot competitor-icon"></i>
                                        <div class="competitor-details">
                                            <h6>@(match.Competitor2?.Name ?? "TBD")</h6>
                                            <small>@match.Competitor2?.Team</small>
                                        </div>
                                    </div>
                                    @if (!match.IsCompleted && match.Competitor1 != null && match.Competitor2 != null)
                                    {
                                        <form asp-action="SetWinner" method="post" style="display:inline;">
                                            <input type="hidden" name="matchId" value="@match.Id" />
                                            <input type="hidden" name="winnerId" value="@match.Competitor2Id" />
                                            <button type="submit" class="btn btn-sm btn-success">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        </form>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    </div>
}