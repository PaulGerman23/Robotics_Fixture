@model List<RoboticsFixture.Models.Match>

@{
    ViewData["Title"] = "Fixture";
    var category = ViewBag.Category;
    var maxRound = ViewBag.MaxRound;
    var showPodium = ViewBag.ShowPodium;
    var rounds = Model.GroupBy(m => m.Round).OrderBy(g => g.Key).ToList();
}

<div class="mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <h1>
            <i class="fas fa-sitemap me-2"></i> Fixture - @category
        </h1>
        <a asp-action="Index" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Volver
        </a>
    </div>
</div>

@if (!Model.Any())
{
    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        No se ha generado el fixture para esta categoría.
        <a asp-action="Index" class="alert-link">Volver para generar</a>
    </div>
}
else
{
    @if (showPodium)
    {
        <div class="alert alert-info mb-4">
            <i class="fas fa-trophy me-2"></i>
            ¡El torneo ha finalizado!
            <a asp-action="Podium" asp-route-category="@category" class="alert-link fw-bold">Ver Podio de Ganadores</a>
        </div>
    }

    <div class="fixture-container">
        @{
            var repechajeRound0 = Model.Where(m => m.Round == 0 && m.IsRepechaje).ToList();
            if (repechajeRound0.Any())
            {
                <div class="repechaje-section mb-5">
                    <div class="repechaje-header">
                        <i class="fas fa-random me-2"></i> REPECHAJE INICIAL
                    </div>
                    @foreach (var match in repechajeRound0)
                    {
                        <div class="match-card repechaje @(match.IsCompleted ? "completed" : "")">
                            <div class="repechaje-badge">
                                <i class="fas fa-exclamation-triangle me-2"></i>VS EXTRA
                            </div>

                            <div class="competitor-slot @(match.WinnerId == match.Competitor1Id ? "winner" : "")">
                                <div class="competitor-info">
                                    <i class="fas fa-robot competitor-icon"></i>
                                    <div class="competitor-details">
                                        <h6>@match.Competitor1?.Name</h6>
                                        <small>@match.Competitor1?.Team</small>
                                    </div>
                                </div>
                                @if (!match.IsCompleted)
                                {
                                    <form asp-action="SetWinner" method="post" style="display:inline;">
                                        <input type="hidden" name="matchId" value="@match.Id" />
                                        <input type="hidden" name="winnerId" value="@match.Competitor1Id" />
                                        <button type="submit" class="btn btn-sm btn-success">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </form>
                                }
                            </div>

                            <div class="match-vs">
                                <i class="fas fa-bolt"></i> VS <i class="fas fa-bolt"></i>
                            </div>

                            <div class="competitor-slot @(match.WinnerId == match.Competitor2Id ? "winner" : "")">
                                <div class="competitor-info">
                                    <i class="fas fa-robot competitor-icon"></i>
                                    <div class="competitor-details">
                                        <h6>@match.Competitor2?.Name</h6>
                                        <small>@match.Competitor2?.Team</small>
                                    </div>
                                </div>
                                @if (!match.IsCompleted)
                                {
                                    <form asp-action="SetWinner" method="post" style="display:inline;">
                                        <input type="hidden" name="matchId" value="@match.Id" />
                                        <input type="hidden" name="winnerId" value="@match.Competitor2Id" />
                                        <button type="submit" class="btn btn-sm btn-success">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </form>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
        }

        <div class="rounds-wrapper">
            @for (int r = 1; r <= maxRound; r++)
            {
                var roundMatches = rounds.FirstOrDefault(g => g.Key == r)?.ToList() ?? new List<Match>();
                var roundName = r == maxRound && roundMatches.Count == 1 ? "FINAL" :
                r == maxRound - 1 && roundMatches.Count == 2 ? "SEMIFINAL" :
                r == maxRound - 2 && roundMatches.Count == 4 ? "CUARTOS" :
                $"RONDA {r}";

                <div class="round-column">
                    <div class="round-header">
                        <i class="fas fa-layer-group me-2"></i>@roundName
                    </div>

                    @foreach (var match in roundMatches)
                    {
                        <div class="match-card @(match.IsCompleted ? "completed" : "") @(match.IsRepechaje ? "repechaje" : "")">
                            @if (match.IsCompleted && !match.IsRepechaje)
                            {
                                <div class="winner-badge">
                                    <i class="fas fa-trophy"></i>
                                </div>
                            }

                            @if (match.IsRepechaje)
                            {
                                <div class="repechaje-badge">
                                    <i class="fas fa-exclamation-triangle me-2"></i>REPECHAJE R@r
                                </div>
                            }

                            <div class="competitor-slot @(match.WinnerId == match.Competitor1Id ? "winner" : "")">
                                <div class="competitor-info">
                                    <i class="fas fa-robot competitor-icon"></i>
                                    <div class="competitor-details">
                                        <h6>@(match.Competitor1?.Name ?? "TBD")</h6>
                                        <small>@match.Competitor1?.Team</small>
                                    </div>
                                </div>
                                @if (!match.IsCompleted && match.Competitor1 != null && match.Competitor2 != null)
                                {
                                    <form asp-action="SetWinner" method="post" style="display:inline;">
                                        <input type="hidden" name="matchId" value="@match.Id" />
                                        <input type="hidden" name="winnerId" value="@match.Competitor1Id" />
                                        <button type="submit" class="btn btn-sm btn-success">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </form>
                                }
                            </div>

                            <div class="match-vs">
                                <i class="fas fa-bolt"></i> VS <i class="fas fa-bolt"></i>
                            </div>

                            <div class="competitor-slot @(match.WinnerId == match.Competitor2Id ? "winner" : "")">
                                <div class="competitor-info">
                                    <i class="fas fa-robot competitor-icon"></i>
                                    <div class="competitor-details">
                                        <h6>@(match.Competitor2?.Name ?? "TBD")</h6>
                                        <small>@match.Competitor2?.Team</small>
                                    </div>
                                </div>
                                @if (!match.IsCompleted && match.Competitor1 != null && match.Competitor2 != null)
                                {
                                    <form asp-action="SetWinner" method="post" style="display:inline;">
                                        <input type="hidden" name="matchId" value="@match.Id" />
                                        <input type="hidden" name="winnerId" value="@match.Competitor2Id" />
                                        <button type="submit" class="btn btn-sm btn-success">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </form>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
}

<style>
    .repechaje-section {
        background: linear-gradient(135deg, rgba(255, 159, 0, 0.1), rgba(255, 71, 87, 0.1));
        border: 3px solid #ff9f00;
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 10px 40px rgba(255, 159, 0, 0.4);
    }

    .repechaje-header {
        text-align: center;
        font-size: 2rem;
        font-weight: 900;
        color: #ff9f00;
        font-family: 'Orbitron', sans-serif;
        text-shadow: 0 0 20px rgba(255, 159, 0, 0.8);
        margin-bottom: 2rem;
        animation: repechajeGlow 2s ease-in-out infinite;
    }

    @@keyframes repechajeGlow {
        0%, 100% { text-shadow: 0 0 20px rgba(255, 159, 0, 0.8); }
        50% { text-shadow: 0 0 30px rgba(255, 159, 0, 1), 0 0 40px rgba(255, 159, 0, 0.8); }
    }

    .match-card.repechaje {
        border-color: #ff9f00;
        background: linear-gradient(135deg, rgba(255, 159, 0, 0.15), rgba(255, 71, 87, 0.1));
        box-shadow: 0 8px 30px rgba(255, 159, 0, 0.4);
        position: relative;
    }

    .repechaje-badge {
        background: linear-gradient(135deg, #ff9f00, #ff7700);
        color: #0a0f1f;
        padding: 0.6rem 1.2rem;
        border-radius: 25px;
        font-weight: 900;
        font-family: 'Orbitron', sans-serif;
        text-align: center;
        margin-bottom: 1rem;
        box-shadow: 0 6px 20px rgba(255, 159, 0, 0.5);
        animation: badgePulse 2s ease-in-out infinite;
    }

    .repechaje-badge i {
        color: #ffffff;
        filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.8));
    }
</style>