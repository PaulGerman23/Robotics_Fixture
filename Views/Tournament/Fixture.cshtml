@model List<RoboticsFixture.Models.Match>

@{
    ViewData["Title"] = "Fixture";
    var tournament = ViewBag.Tournament as RoboticsFixture.Models.Tournament;
    var showPodium = ViewBag.ShowPodium;
    var extraMatchRound0 = Model.Where(m => m.Round == 0 && m.IsExtraMatch).ToList();
    
    // Excluir Round 0 del cálculo de maxRound y rounds para el fixture
    var regularMatches = Model.Where(m => m.Round > 0).ToList();
    var maxRound = regularMatches.Any() ? regularMatches.Max(m => m.Round) : 0;
    var rounds = regularMatches.GroupBy(m => m.Round).OrderBy(g => g.Key).ToList();
    
    // Verificar si hay Play-In pendiente
    var hasPlayInPending = extraMatchRound0.Any(m => !m.IsCompleted);
}

<!-- Agregar CSS del bracket -->
<link rel="stylesheet" href="~/css/bracket-fixture.css">

<div class="mb-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div>
            <h1><i class="fas fa-sitemap me-2"></i> Fixture - @tournament?.Name</h1>
            <div class="mt-2">
                <span class="badge" style="background:@(tournament?.CombatMode==RoboticsFixture.Models.Enums.CombatMode.Autonomous?"linear-gradient(135deg,#00e5ff,#0099ff)":"linear-gradient(135deg,#ff9f00,#ff7700)");color:#0a0f1f;font-size:1rem;padding:.6rem 1.2rem;">
                    @if(tournament?.CombatMode==RoboticsFixture.Models.Enums.CombatMode.Autonomous)
                    {
                        <i class="fas fa-robot me-2"></i><text>Modo Autónomo (Sumo LNR)</text>
                    }
                    else
                    {
                        <i class="fas fa-gamepad me-2"></i><text>Modo Radiocontrol (Batalla Robot)</text>
                    }
                </span>
                <span class="badge bg-secondary ms-2" style="font-size:1rem;padding:.6rem 1.2rem;">
                    <i class="fas fa-tag me-2"></i>@tournament?.Category
                </span>
            </div>
        </div>
        <a asp-action="Index" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Volver</a>
    </div>
</div>

@if (!Model.Any())
{
    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        No hay combates disponibles para este torneo. Por favor, genere el fixture primero.
    </div>
}
else
{
    if (showPodium)
    {
        <div class="alert alert-success mb-4">
            <i class="fas fa-trophy me-2"></i>¡El torneo ha finalizado!
            <a asp-action="Podium" asp-route-tournamentId="@tournament?.Id" class="alert-link fw-bold">
                Ver Podio de Ganadores
            </a>
        </div>
    }

    @if (hasPlayInPending)
    {
        <div class="alert alert-danger mb-4">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Combate Extra pendiente:</strong> Complete el Play-In antes de continuar con el torneo.
        </div>
    }

    <!-- Diseño Bracket -->
    <div class="bracket-fixture-wrapper">
        <div class="container">
            <!-- Encabezado del Torneo -->
            <div class="bracket-tournament-header">
                <h2 class="bracket-tournament-title">
                    <i class="fas fa-trophy"></i>
                    TORNEO PRINCIPAL - CUADRO ELIMINATORIO
                    <i class="fas fa-chevron-down"></i>
                </h2>
            </div>

            <!-- Bracket Container -->
            <div class="bracket-container">
                @for(int r = 1; r <= maxRound; r++)
                {
                    var roundMatches = rounds.FirstOrDefault(g => g.Key == r)?.ToList() ?? new List<RoboticsFixture.Models.Match>();
                    var roundName = r == maxRound && roundMatches.Count == 1 ? "FINAL" :
                                    r == maxRound - 1 && roundMatches.Count == 2 ? "SEMIFINAL" :
                                    r == maxRound - 2 && roundMatches.Count == 4 ? "CUARTOS DE FINAL" :
                                    $"RONDA DE {Math.Pow(2, maxRound - r + 1)}";
                    
                    <div class="bracket-round-column">
                        <div class="bracket-round-header">
                            @roundName
                        </div>
                        
                        <div class="bracket-matches-wrapper">
                            @foreach(var match in roundMatches)
                            {
                                <div class="bracket-match-card @(match.IsCompleted ? "completed" : "")">
                                    <!-- Competidor 1 (Cyan) -->
                                    <div class="bracket-competitor-row cyan-side @(match.WinnerId == match.Competitor1Id ? "winner" : "")">
                                        <div class="bracket-competitor-info">
                                            <div class="bracket-robot-icon">
                                                <i class="fas fa-robot"></i>
                                            </div>
                                            <div class="bracket-competitor-details">
                                                <h6 class="bracket-competitor-name">
                                                    @(match.Competitor1?.Name ?? "TBD")
                                                </h6>
                                                <small class="bracket-competitor-team">
                                                    @(match.Competitor1?.Team ?? "Sin equipo")
                                                </small>
                                            </div>
                                        </div>
                                        
                                        @if (!match.IsCompleted && match.Competitor1 != null && match.Competitor2 != null)
                                        {
                                            <form asp-action="SetWinner" method="post" style="display:inline;">
                                                <input type="hidden" name="matchId" value="@match.Id" />
                                                <input type="hidden" name="winnerId" value="@match.Competitor1Id" />
                                                <button type="submit" class="bracket-winner-indicator selectable">
                                                    <i class="fas fa-arrow-up"></i>
                                                </button>
                                            </form>
                                        }
                                        else if (match.IsCompleted && match.WinnerId == match.Competitor1Id)
                                        {
                                            <div class="bracket-winner-indicator selected">
                                                <i class="fas fa-trophy"></i>
                                            </div>
                                        }
                                    </div>
                                    
                                    <!-- Competidor 2 (Rojo) -->
                                    <div class="bracket-competitor-row red-side @(match.WinnerId == match.Competitor2Id ? "winner" : "")">
                                        <div class="bracket-competitor-info">
                                            <div class="bracket-robot-icon">
                                                <i class="fas fa-robot"></i>
                                            </div>
                                            <div class="bracket-competitor-details">
                                                <h6 class="bracket-competitor-name">
                                                    @(match.Competitor2?.Name ?? "TBD")
                                                </h6>
                                                <small class="bracket-competitor-team">
                                                    @(match.Competitor2?.Team ?? "Sin equipo")
                                                </small>
                                            </div>
                                        </div>
                                        
                                        @if (!match.IsCompleted && match.Competitor1 != null && match.Competitor2 != null)
                                        {
                                            <form asp-action="SetWinner" method="post" style="display:inline;">
                                                <input type="hidden" name="matchId" value="@match.Id" />
                                                <input type="hidden" name="winnerId" value="@match.Competitor2Id" />
                                                <button type="submit" class="bracket-winner-indicator selectable">
                                                    <i class="fas fa-arrow-down"></i>
                                                </button>
                                            </form>
                                        }
                                        else if (match.IsCompleted && match.WinnerId == match.Competitor2Id)
                                        {
                                            <div class="bracket-winner-indicator selected">
                                                <i class="fas fa-trophy"></i>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}
